
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNGSI BANTUAN (HELPER) ---
    
    // Cek apakah user sudah login
    function isSignedIn() {
      return request.auth != null;
    }

    // Cek apakah user yang mengakses adalah pemilik data (berdasarkan UID)
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // --- ATURAN KOLEKSI ---

    // 1. KOLEKSI USERS
    match /users/{userId} {
      // IZINKAN BACA (READ): 
      // Wajib diizinkan untuk semua user yang sudah login (isSignedIn).
      // Alasannya:
      // a. Saat Register: Aplikasi perlu mengecek seluruh user untuk memastikan Nomor HP unik.
      // b. Saat Chat: Aplikasi perlu mengambil foto & nama lawan bicara.
      allow read: if isSignedIn();
      
      // IZINKAN TULIS (CREATE/UPDATE):
      // Hanya pemilik akun (isOwner) yang boleh membuat atau mengubah datanya sendiri.
      // Ini mencegah orang lain mengedit profil Anda.
      allow create, update: if isSignedIn() && isOwner(userId);
      
      // Sub-koleksi Contacts (Daftar Kontak User)
      match /contacts/{contactId} {
        // Hanya pemilik akun yang boleh melihat dan mengedit kontaknya sendiri.
        allow read, write: if isSignedIn() && isOwner(userId);
      }
    }

    // 2. KOLEKSI CHATS
    match /chats/{chatId} {
      // Membuat Chat: Diizinkan jika UID pembuat ada di dalam daftar 'participants'
      allow create: if isSignedIn() && request.resource.data.participants.hasAny([request.auth.uid]);
      
      // Baca/Edit/Hapus Chat: Hanya diizinkan jika user adalah salah satu peserta chat tersebut
      allow read, update, delete: if isSignedIn() && (request.auth.uid in resource.data.participants);

      // Sub-koleksi Messages (Pesan di dalam Chat)
      match /messages/{messageId} {
        // Baca & Kirim Pesan:
        // Diizinkan jika user terdaftar sebagai peserta di dokumen induk (Chat)
        allow read, create: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Hapus Pesan:
        // Hanya pengirim pesan (senderId) yang boleh menghapus pesannya sendiri
        allow delete: if isSignedIn() && (request.auth.uid == resource.data.senderId);
      }
    }
  }
}
